# SpringCloud alibaba

## 1. 为什么需要微服务

早期互联网公司为了解决成本的问题都会采用单体架构方式，所有模块都存储在一个项目包括前端。或者好一点公司可能会采用前后端分离的方式来实现项目功能。但是随着业务增长 用户访问量也会逐步增长 ... 这样这种架构方式肯定不能满足现有需求

比如：订单访问量比较多 用户个人信息比较少 ... 针对这些比较多使用的功能单独开发 提高更高并发量的控制 其他访问量少的功能 可以少一些并发量

比如：积分模块 如果出现计算错误 都会导致整个应用造成宕机

所以后续出现了微服务架构，将原有项目中这么多模块的功能 每一个功能都变成一个微小的服务 而每一个微小的服务都是单独的应用(springboot项目) 他们之间可以独立部署 独立开发 互不影响 服务之间通过远程调用来访问其他功能

## 2. 系统演变过程

![345fc5b167c9b0f4e9e84c8f971c11af](https://s2.loli.net/2024/09/12/P5KUvXVLwrQas4o.png)

#### 2.1 单体架构

互联网早期 一个网址需求特别小，只需要一个应用 将所有代码都放在一台服务器运行 优点：减少开发成本 和 维护成本 缺点：不能针对指定模块 做优化或者拓展 而且单点服务器容错率特别低

#### 2.2 垂直架构

随着项目访问量越来越多时，有一些模块经常会需要很大的并发量 比如：订单模块  也有一些模块 需要很小并发量 比如：用户模块 如果我想针对订单模块 增加 一些新功能 为了提高并发量 而用户模块不用增加 那么单体架构很难实现 所以出现了垂直架构

垂直架构：将原来一个应用 拆成几个互不相干的应用 这样就可以单独对一个应用去针对性开发 比如：有一套系统 拆分成三个子系统

- 电商系统(用户模块 商品模块 订单模块)
- 后台系统(用户管理 商品管理 订单管理)
- CMS系统(广告模块 营销模块 ...)

这样拆分完毕后 一旦用户访问量过大 只需要优化电商系统即可 其他系统无需管理 优点在于 可以分流 解决了并发问题 可以针对不同应用研发和迭代

缺点：系统之间是互不相干的 无法进行互相调用 也会出现很多重复性的开发	

#### 2.3 分布式架构

当垂直架构应用越来越多，重复处理业务功能也会越来越多 所以就应该需要把这些重复的业务提取出来 做成一个统一的业务层 作为独立服务存在 由前端控制层调用不同的业务层服务 这样就可以形成分布式架构 他们之间通过==远程调用==来访问公共的服务层来实现自己的业务功能 

优点：提高代码复用性 减少开发成本 

缺点：调用的关系错综复杂 难以维护

#### 2.4 SOA架构

在分布式架构中，当服务越来越多 服务之间调用是非常复杂的 所以SOA架构 增加了一个调度中心(注册中心 服务中心) 如果需要访问服务 都需要在调度中心进行注册 才可以访问

优点：调度中心解决服务之间调用错综复杂 还可以实现自动熔断 将一些报错的服务下线处理 其他服务就无需浪费时间来访问这个报错的服务

缺点：服务之间会有依赖性  都需要在调度中心注册 需要调用其他服务 也需要从调度中心获取 一个环节出现问题 很多环节也会出现问题

#### 2.5 微服务架构

微服务就是面向服务的SOA架构，它将服务拆分更加彻底 并且SOA中的缺点都可以很好的解决 相比SOA架构更加精细 每个服务之间互不影响 每个服务独立部署 甚至强调每个服务都可以使用单独数据库 这样就可以保证每个服务互不影响 所以微服务架构 更加适合做大型 互联网 网址 或者应用

## 3. 微服务架构常见问题

一旦采用微服务架构 势必会出现以下这些情况

- 这么多微小服务，如何管理他们？（注册中心 zoopeeper eureka nacos）
- 他们之间如何实现相互通信？（RPC dubbo httpclient feign）
- 用户客户端(APP 浏览器)如何访问他们？（网关zuul gateway）
- 一旦服务出现问题 怎么自动处理？（熔断机制 hystrix sentinel）
- 既然服务出现了错误 如何进行排错？（链路追踪）

## 4. 微服务架构主流解决方案

- 阿里系：zookeeper+dubbo+springboot 通信方式通过dubbo做远程调用，注册中心通过zookeeper 由于是阿里研发 后面不维护了 捐给apache
- spring系：spring全家桶+嵌入式第三方组件(Netflix) 通信方式通过restFul+restTemplate 注册中心 eureka 配置中心Config 熔断器hystrix 网关zuul  负载均衡(Ribbon)  但是现在NetFlix不再更新了
- SpringCloud alibaba系：目前最主流开发模式 并且很多开发模式 微服务架构 跟spring系很相似 它相当于spring系 优化的稳定版
  服务中心(nacos可以注册 可以配置)  网关(gateway)  通信方式(OpenFeign Feign)  熔断器(Sentinel)  负载均衡(loadBalance)

#### 4.1 SpringCloud alibaba环境依赖图 ---重要

根据对应SpingCloud版本选择对应微服务架构，版本一定要兼容 否则 很多组件都会失效 要先根据springBoot版本--->对应的alibaba版本--->对应的组件版本

![9](https://s2.loli.net/2024/09/12/E9aLsAD1ClyYrKq.png)

## 5. Nacos组件 ---重点组件 项目中必加的组件

Nacos是SpringCloud alibaba最核心的组件，本身是基于C/S 主要用于动态服务发现，服务管理和服务配置 还可以设置权限 集成了三种主要功能 (注册中心 配置中心 服务管理等功能) 这样其他服务就可以通过服务名进行远程调用 其他服务，而且nacos还提供一个可视化的界面 动态管理所有服务

#### 5.1 Nacos服务端搭建

- 下载  *.zip 兼容window		*.tar.gz 兼容linux
  - [Nacos官网地址](https://nacos.io/zh-cn/index.html)
  - [Nacos帮助文档](https://nacos.io/zh-cn/docs/concepts.html)
  - [GitHub下载页面](https://github.com/alibaba/nacos/releases)

- 安装：只需要解压即可(本机解压都 D:\Program Files\nacos)

![image-20240912165545393](https://s2.loli.net/2024/09/12/iOfwSKIyndmaZMx.png)

- 配置：

  - 配置bin目录启动文件 startup.xmd  因为它默认是集群模式启动，所以需要修改成单点服务器才可以启动 

    ```
    set MODE="cluster"	修改成   set MODE="standalone"
    ```

  - conf目录 `application.properties` 是nacos配置文件 目前可以不用修改 它的默认配置都是没有问题的

- 启动：双击运行(以管理员身份运行) startup.cmd文件 启动nacos 等待出现 successfully in stand alone mode
- 测试：localhost:8848/nacos/index.html   默认账号密码都是：nacos

![image-20240913113306863](https://s2.loli.net/2024/09/13/CZBVxqOvia1F5tQ.png)

#### 5.2 Nacos客户端搭建

所有的服务都是客户端 都需要连Nacos

- 先创建一个父模块：SpringCloudAlibaba 不选择任何的依赖
  - 后期如果明确了很多子项目(服务) 如果有很多相同的依赖 父项目可以设置这些统一的依赖 将自己设置成pom 让子项目继承即可
- 模拟 订单购物的功能(订单服务 调用商品服务 调用库存服务)
- 创建一个订单服务(springboot项目)，右键SpringCloudAlibaba模块-> new Module

![image-20240913114609785](https://s2.loli.net/2024/09/13/ClSbYH3tGL8pjDq.png)

![image-20240913115733195](https://s2.loli.net/2024/09/13/pc4rOWvEe1dJfij.png)

- 配置订单功能（properties配置文件也可以，但是一般都是用yml格式的配置文件）

```yml
# yml配置相比properties配置区别
# yml配置可以减少一份份代码冗余
# yml配置可以让配置更有层次感
# 注意：1.上下级 必须强制加缩进
#      2.最终写数据时 : 后面一定要加空格 否则不识别
server:
  port: 8000 #配置端口号

spring:
  application:
    name: order-service #应用名
  cloud:
    nacos:
      server-add: 127.0.0.1:8848 #nacos服务端地址
      discovery:
        username: nacos #nacos账号
        password: nacos #nacos密码
        namespace: public #默认的命名空间
        ephemeral: true #是否是临时实例
```

- 再创建一个库存服务（springboot项目 stock）

![7fa0799b2507f8a0306bb8985f641345](https://s2.loli.net/2024/09/13/7qQuEWDomXIwh5v.png)

- 订单服务提供一个下单功能 需要远程调用库存 减少库存功能

  - 提供减少库存接口地址

  ```java
  @RestController
  public class StockController {
      @Value("${server.port}")
      int port;
      @RequestMapping("/reduce")
      public Result reduce(){
          System.out.println("减少库存");
          return new Result(1,"减少库存成功："+port);
      }
  }
  ```

  - 提供下单功能接口地址

  ```java
  @RestController
  public class OrderController {
      @Autowired
      RestTemplate rt;
      @RequestMapping("/add")
      public Result add(){
          System.out.println("下单成功");
          //自己先执行自己下单业务
          //调用库存服务 减少库存
          //rt.getForObject("其他服务地址",响应结果类型) 进程远程调用
          //也可以实现调用第三方接口 地址 比如：短信接口 支付接口 天气接口
          Result stockResult = rt.getForObject("http://stock-service/reduce", Result.class);
          return new Result(1,"下单成功,"+stockResult.getMsg());
      }
  }
  ```

- 配置RestTemplate进行远程调用（以后会替换成OpenFeign）

  - 配置一个RestTemplate配置类（Springboot自带的无需导入依赖）

  ```java
  //配置类：配置RestTemplate 用于远程调用其他服务
  @Configuration
  public class RestTemplateConfig {
      @Bean
      @LoadBalanced   //开启负载均衡 这样当前服务才可以通过服务名远程访问其他服务
      RestTemplate restTemplate(RestTemplateBuilder builder) {
          return builder.build();
      }
  }
  ```

  - 在Controller类中注入RestTemplate对象.getForObject("接口地址",响应类型)

- 测试：启动服务器，发送请求下单(localhost:8000/add)：后台可以进行 下单和库存 两个服务的运行

![image-20240913165437176](https://s2.loli.net/2024/09/13/GzrTdv2cJ4WYpfj.png)

#### 5.3 负载均衡 ---面试题

负载均衡是一种计算机网络和系统架构使用技术，用于将请求均匀分布到多个资源 使整个系统可以处理更多的并发请求(提高并发量) 如果其中有一个资源出现问题 它也会自动转发到其他可用资源中

- 确保开启了负载均衡：配置类`RestTemplateConfig`中的方法添加`@LoadBalanced`注解
- 提供多个目标服务的资源(库存服务)
  - 编辑配置

![image-20240913164402023](https://s2.loli.net/2024/09/13/1tn3xrk7WVvoLNq.png)

​		复制服务(实例)

![image-20240913164426010](https://s2.loli.net/2024/09/13/1DQqcGN57XnsKA3.png)

​		修改每个服务的名字和端口号

![3f2ff1d16003797571a9905efc34aace](https://s2.loli.net/2024/09/13/WKhOEbFdrt2Axq4.png)

- 测试 发送6次请求 每个 库存服务都会均匀的分配两次，如果宕机一个库存 服务器，剩余两个库存服务器会各均匀分配三个

![image-20240913165923587](https://s2.loli.net/2024/09/13/HC4YorBzZPUS15A.png)

#### 5.4 Nacos集群搭建

- 官网下载nacos   *.tar.gz	*.zip		推荐使用linux  传输到linux中去
- 创建三个nacos集群节点   （先搞一个然后复制两份，通过tar -xvf 解压 nacos，然后改名）

```
tar -xvf nacos-2.2.0.tar.gz...
mv nacos nocos8849
```

- conf/application.properties 修改端口号，数据源开启

![image-20240913193120096](https://s2.loli.net/2024/09/13/jGHz6maQR7eTw8I.png)

- 打开linux本机安装的mysql 创建nacos数据库，利用它提供的sql文件(conf/mysql-schema.sql)创建表
- conf/cluster.conf.example 改成 cluster.conf 表示要启用集群配置文件，并配置集群中的服务地址

```
# 几个节点ip和端口
192.168.11.27:8849
192.168.11.27:8850
192.168.11.27:8851
```

- 可选：修改nacos集群启动时所消耗的内存占比   修改的是 bin/startup.sh 文件中

![image-20240913193432852](https://s2.loli.net/2024/09/13/tyWMUGKfFC5dB3Y.png)

- 启动：通过 bin/startup.sh 启动即可 等待它出现success  如果太卡了 不要启动三个

```
测试：
ip地址:端口号/nacos
192.168.11.27:8848/nacos
```

==注：nacos配置集群时 版本2X以上 有一个RPC通信协议 默认给端口添加1000和1001的偏移量 可能会跟自带的端口号冲突，就会导致一台电脑上启动多个集群失败，但是实际开发中一台电脑只会有一个服务，只需要一个端口就好==
